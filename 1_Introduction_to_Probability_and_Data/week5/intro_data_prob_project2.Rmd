---
title: "Exploring the BRFSS data"
output: 
  html_document: 
    fig_height: 4
    highlight: pygments
    theme: spacelab
---

## Setup

### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
source('multiplot.r')
```

### Load data

Make sure your data and R Markdown files are in the same directory. When loaded
your data file will be called `brfss2013`. Delete this note when before you submit 
your work. 

```{r load-data}
load("brfss2013.RData")
```



* * *

## Part 1: Data

The data used for the research has been collected by the Centers for Disease Control and Prevention (CDC) and US States for the year 2013. This study aimed at analysing behavioral risk factors and preventive health practices and the related health condition. There are 330 variables and 491775 subjects in the 2013 data file. Thoses variables contains informations related to :

- demographics and social context,

- health care access,

- behavioral features (e.g. tobacco use, physical activity),

- current health condition, 

- pathology screening.


#### Cases
The cases are non-institutionalized adults residing in the US.

#### Sampling methodology

Interviews are either via landline of cell phone.
For landline calls, a stratified sampling process has been used for the selection of the number : 1 stratum for high density numbers; an other for medium density.
On top of this sampling technique, the landlines calls have sampled with one randomly selected adult ofr for each household.

For cell calls, a simple random sampling based on the phone number, for person receiving  90% or more of the calls per cell phone.

#### Scope of inference

Since the study does consist in a telephone survey on randomly selected adults and no treatments is randomly assigned to the subjects, we can considere it as an **observational study**.

Therefore we can conclude on **associations** but not on causality between the explanatory variables (behavior and practices) and the response (health condition).

From those points we can infer that the results observed in this study can be **generalizable** on the non-institutionalized adults residing in the US, but no causality can be drawn.



* * *

## Part 2: Research questions

**Research quesion 1:** Is there an association between the quantity of sleep `sleptim1`, tobacco use frequency `smokday2` and alcohol consumtion `avedrnk2` ?

**Research quesion 2:** Are veterans `veteran3` more likely to be single `marital` and more prone to be in poor health `poorhlth` ?

**Research quesion 3:** Are people eating more fruit `fruit1` more likely to use their seatbelt `seatbelt` ?


* * *

## Part 3: Exploratory data analysis

NOTE: Insert code chunks as needed by clicking on the "Insert a new code chunk" 
button (green button with orange arrow) above. Make sure that your code is visible
in the project you submit. Delete this note when before you submit your work.

**Research question 1:**
Is there an association between the quantity of sleep `sleptim1`, tobacco use frequency `smokday2` and alcohol consumtion `avedrnk2` ?


First we can script a function to get the NA ratio for each variable.

If there is a low answer rate (<5%), it does not make sense to proceed further.

```{r}

# useful method to check the NA ratio in the features
NA.ratio <- function(df,cols){
  df_selected <- df %>% select(one_of(cols)) 
  print ('missing answer ratio : ')
  (colMeans(is.na(df_selected))) %>% t()
}

```

Let's see what we get with our three variables in scope :

```{r}
features_1 <- c("sleptim1","smokday2","avedrnk2")

NA.ratio(brfss2013,features_1)

```
OK, we can move forward.

```{r}
df_q1<-brfss2013 %>% select(one_of(features_1)) %>% na.omit()
```

How is the smoking habit spread ?

```{r}
df_q1 %>% group_by(smokday2) %>% summarise(count=n()) %>% mutate(ratio=count/sum(count)*100)
```
One third of the interviewees do smoke.

We can check the distribution of sleep time amongst the three smoke groups:


```{r}
ggplot(data=df_q1, aes(x=smokday2,y=sleptim1, fill=smokday2)) + geom_boxplot()
```

There is no obvious differences amongst the three groups.

Now we can add the drinking habit and focus on the two smoking habit extremes (smoke everyday and not at all): 
```{r}
ggplot(data=df_q1 %>% filter(smokday2!='Some days'), aes(x=avedrnk2,y=sleptim1,color=smokday2)) + geom_point(alpha=0.5,position = 'jitter')
```
The plot lacks clarity, let's group the values per range for `sleptim1` and `avedrnk2` :

```{r}
df_q1_no_na_binned <- df_q1 %>% select(sleptim1,avedrnk2,smokday2)  %>% na.omit() %>% mutate(sleep_time_bin = ntile(sleptim1, 5), avedrnk_bin= ntile(avedrnk2,10))
ggplot(data=df_q1_no_na_binned %>% filter(smokday2!='Some days'), aes(x=avedrnk_bin,y=sleep_time_bin,color=smokday2)) + geom_point(alpha=.5,position = 'jitter')

```

Now we can see that heavy smokers who do drink a lot tend to sleep less than the rest of the population.




**Research question 2:**
Are veterans `veteran3` more likely to be single `marital` and more prone to be in poor health `poorhlth` ?
```{r}

features_2 <- c("veteran3","marital","poorhlth")

NA.ratio(brfss2013,features_2)

```

There is no significant proportion of NA is the three variables.

```{r}
df_q2<-brfss2013 %>% select(one_of(features_2))

df_q2_no_na<-df_q2 %>% na.omit()

```


Let's see if veterans are more likely to be single :
We first group the data per `veteran3` and `marital` status :
```{r}
groupy<- df_q2_no_na %>% group_by(veteran3,marital) %>% summarise(count=n()) %>% mutate(ratio=count/sum(count))
head(groupy)
```
To improve clarity, i rename the last marital category :


```{r}
df_q2_no_na<- df_q2_no_na %>% mutate(marital=ifelse(marital=='A member of an unmarried couple','Unmarried couple',as.character(marital)))
```


```{r}
ggplot(groupy, aes(marital, ratio)) +  geom_bar(aes(fill = veteran3), position = "dodge", stat="identity") 
```


Veterans are more likely to be married and divorced. 

Let's see how healthy are the veterans vs the others amongst each marital categories :


```{r}
p1<-ggplot(data=df_q2_no_na %>% filter(veteran3=='No'), aes(x=marital,y=poorhlth,fill=marital)) + geom_boxplot() +  xlab("Non veterans")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme(legend.position="none")
p2<-ggplot(data=df_q2_no_na %>% filter(veteran3=='Yes'), aes(x=marital,y=poorhlth,fill=marital)) + geom_boxplot()  +  xlab("Veterans")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme(legend.position="none")

 layout <- matrix(c(1,2), nrow = 2, byrow = TRUE)
  multiplot(p1,p2,cols=2,layout=layout)
```



**Research question 3:**

Are people eating more fruit `fruit1` more likely to use their seatbelt `seatbelt` ?

In this case, the `fruit1` variable has to be a little bit reworked.
Looking a the `fruit1` definition in the  2013 BRFSS Codebook report :

| Value   	| Label           
|----------	|---------------	|
| 101 - 199  	| Times per day  	|
| 201 - 299 	| Times per week     	| 
| 300 	| Less than one time per month 	|
| 301 - 399 	| Times per month	|
| 555  	| Donâ€™t know/Not sure  	|
| 777 	| Times per day  	|
| 999 | Refused  	|
| BLANK  	| Not asked or Missing   	|

We can define categories rather than numeric values :

```{r}
categorize_fruits <- function(cell){
  if(cell==300){
    return("4_< Once in month")
  }
      if(cell<400 & cell>100){
    group<-cell%/%100
     return(switch(group,'1_day','2_week','3_month'))
  } else{
    return("5_NA")
  }
  }
  

fruit_and_seatbelt <-brfss2013 %>% select(fruit1,seatbelt) %>% na.omit() %>% rowwise()  %>%mutate(fruit_group =categorize_fruits(fruit1))  %>%ungroup()
groupy<- fruit_and_seatbelt %>% filter(fruit_group!="5_NA") %>% group_by(fruit_group,seatbelt) %>% summarise(count=n()) %>% mutate(ratio=count/sum(count))

ggplot(arrange(groupy,fruit_group), aes(seatbelt, ratio)) +  geom_bar(aes(fill = fruit_group), position = "dodge", stat="identity") 

```

As i was susptecting, people eating more fruits are more likely to fasten their seatbelt, and people not eating fruits are more prone to drive without seatbelt.


