---
title: "Statistical inference with the GSS data"
output: 
  html_document: 
    fig_height: 4
    highlight: pygments
    theme: spacelab
---

## Clement LEFEVRE 10th April 2017.

### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(statsr)
library(ggcorrplot)

```

### Load data


```{r load-data}
load("gss.Rdata")
```



* * *

## Part 1: Data

This dataset is a simplified sample of the official General Social Survey (GSS).
The [GSS](http://publicdata.norc.org:41000/gss/documents//BOOK/GSS_Codebook_AppendixA.pdf) is a survey focusing on US society, gathering informations related to **societal behaviors and attitudes**.
The data were gathered via interviews by US households.

#### Sampling methodology

**Random sampling** is implemented via strata : geographical area, sex, race, etc.
This study has been done for 40 years.


#### Case

Cases here are **adults living the US**.

#### Scope of inference

For the elements exposed (random sampling, no treatment assigned to random subjects), we can state that this is an **observational** study, from which we can extract **assocations** but no **causality** between the explanatory variables (demographics and social) and  the response (opinion, attitude). 


* * *

## Part 2: Research question
Based on this dataset, i'd like to evaluate the possible association between race and gun ownership, and its evolution over years.

As a french, two factors in the US society seem very specifics to me : the racial discrimation and the attitude towards guns.

This short analysis will try to evaluate whether both are somehow related.


* * *

## Part 3: Exploratory data analysis


First, we can have a look at the distribution of interviewees's race over the years  :

```{r}
group_per_year <- gss %>% group_by(year) %>% summarise(count=n())  
average_interviews_per_year <-mean(group_per_year $count)
print (average_interviews_per_year)
group_per_year <- gss %>% group_by(year,race) %>% summarise(total_interviews = n())
ggplot(data=group_per_year,aes(x=year,y=total_interviews,fill=race)) + geom_bar(stat='identity')+geom_hline(yintercept = mean(average_interviews_per_year),colour="blue", linetype="dashed")+annotate("text", x=1980, y=average_interviews_per_year*1.1, label="average interviews", color = "blue")
summary(group_per_year)
```


Two elements to be noticed here :

- the average yearly **number of interviewees** is relatively **stable** over year.
- frequency of interviews switched from every year to every two years from 1993 onwards.
- **race split** with the exception of 2 years (1982,1987 : black oversampling) is also **stable.**


Now we can focus on race and gun ownership.
We first create a dataframe with the variables of interest and some additional ones :

- `year` : year of interview
- `age` : Age of respondent
- `sex` : Respondent's sex
- `fear`: Afraid to walk at night in neighborhood
- `owngun` : Have gun in home
- `educ` :  Highest year of school completed
- `coninc` : Total family income in constant dollars

```{r}
weapon_df <- gss %>% select(year,fear,owngun,sex,age,race,educ,coninc)
str(weapon_df)
```



Let's see for both variable the non-answered ratio :
```{r}
as.data.frame(colMeans(is.na(weapon_df))*100)
```

From this table, we can say that even if 40% of interviewees did not provide an answer for `fear` and `owngun`, which, according to the sample size (57061 interviewees) is acceptable.

```{r}
dim(weapon_df)
weapon_df<- weapon_df %>% na.omit()
nrow(weapon_df)
weapon_df<- weapon_df %>% filter(owngun!='Refused')
dim(weapon_df)
```


Now we can quickly see the Pearson correlation between those variable.
First, we convert the categorical variable into numerics values :


```{r}
weapon_df<- weapon_df %>% mutate(fear_num=ifelse(fear=='Yes',1,0))
weapon_df<- weapon_df %>% mutate(owngun_num=ifelse(owngun=='Yes',1,0))
weapon_df<- weapon_df %>% mutate(sex_num=ifelse(sex=='Male',1,0))
weapon_df<- weapon_df %>% mutate(race_num=ifelse(race=='Black',0,ifelse(race=='White',2,1)))
                                 
```


Let's plot a correlogramm :

```{r}

weapon_df_numeric<- weapon_df %>% select(-c(fear,sex,race,owngun))

corr <- round(cor(weapon_df_numeric),3)
ggcorrplot(corr, hc.order = TRUE, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           method="circle", 
           colors = c("tomato2", "white", "springgreen3"), 
           title="Correlogram of Selected variables", 
           ggtheme=theme_bw)
```


Well, some elements here :

- education level is strongly correlated to the level of incomes.
- the fear factor is correlated to gender.
- for gun ownership, the most correlated variables are in order : race(white are more likely ot own guns than others and blacks), sex (men are more likely to own guns), income (the more income, the more frequent is gunownership).



```{r}


groupy1<- weapon_df  %>% group_by(year,owngun,race) %>% summarise(total=n()) %>% mutate(ratio=total/sum(total))

#ggplot(groupy1,aes(x=year,y=ratio,col=race)) + geom_bar(aes(fill = owngun), stat="identity")

ggplot(groupy1 %>% filter(owngun=='Yes'),aes(x=year,y=ratio,col=race)) + geom_line()

```

```{r}
weapon_df %>% group_by(year,sex) %>% summarise(total=n())
head(weapon_df)

```
```{r}
gun_race <-weapon_df %>% filter(year==2012)  %>% filter(owngun=='Yes' | owngun=='No',owngun!='Refused')

gun_race <- droplevels(gun_race)
gun_race <- table(gun_race$owngun,gun_race$race)
gun_race
chisq.test(gun_race)
```
```{r}
gun_race <-weapon_df %>% filter(year==1973)  %>% filter(owngun=='Yes' | owngun=='No',owngun!='Refused')

gun_race <- droplevels(gun_race)
gun_race <- table(gun_race$owngun,gun_race$race)
gun_race
chi2<- chisq.test(gun_race)

chi2$p.value
```
We can write a generic function to compute the corresponding p.value :

```{r}
chi2_independance_pvalue<- function(df,year_){
gun_race <-df %>% filter(year==year_)  %>% filter(owngun=='Yes' | owngun=='No')

gun_race <- droplevels(gun_race)
gun_race <- table(gun_race$owngun,gun_race$race)

chi2<- chisq.test(gun_race)

return(chi2$p.value)
  
}
```


Let's compute the evolution of this p.value along the years :

```{r}
gun_asked<-gss %>% group_by(year,owngun) %>% filter(!is.na(owngun)) 
year_asked<-unique(gun_asked$year)
```

```{r}

x<-list()
for (year in year_asked){
 chi2 <-  chi2_independance_pvalue(weapon_df,year)
 x[as.character(year)]<-list('pvalue'=chi2)
}

 
df_pvalues<-as.data.frame(x) %>% gather() 
colnames(df_pvalues)
colnames(df_pvalues)<-c('yearX','pvalue')
df_pvalues<- df_pvalues %>% separate(yearX,into = c("X", "year"), sep = "X")
head(df_pvalues)
df_pvalues$log_pvalue<-log(df_pvalues$pvalue)

str(df_pvalues)
ggplot(data=df_pvalues,aes(x=as.numeric(year),y=log_pvalue)) + geom_point()+stat_summary(fun.data=mean_cl_normal) + 
  geom_smooth(method='lm')

```


* * *

## Part 4: Inference

Chi Square independance test :

```{r}

```

