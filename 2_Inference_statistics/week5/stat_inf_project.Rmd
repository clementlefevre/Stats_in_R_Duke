---
title: "Statistical inference with the GSS data"
output: 
  html_document: 
    fig_height: 4
    highlight: pygments
    theme: spacelab
---

## Clement LEFEVRE 10th April 2017.

### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(statsr)
library(ggcorrplot)
library(gridExtra)
library(grid)
library(RColorBrewer)

source('multiplot.r')

```

### Load data


```{r load-data}
load("gss.Rdata")
```



* * *

## Part 1: Data

This dataset is a simplified sample of the official General Social Survey (GSS).
The [GSS](http://publicdata.norc.org:41000/gss/documents//BOOK/GSS_Codebook_AppendixA.pdf) is a survey focusing on US society, gathering informations related to **societal behaviors and attitudes**.
The data were gathered via interviews by US households.

#### Sampling methodology

**Random sampling** is implemented via strata : geographical area, sex, race, etc.
This study has been done for 40 years.


#### Case

Cases here are **adults living the US**.

#### Scope of inference

For the elements exposed (random sampling, no treatment assigned to random subjects), we can state that this is an **observational** study, from which we can extract **assocations** but no **causality** between the explanatory variables (demographics and social) and  the response (opinion, attitude). 


* * *

## Part 2: Research question
Based on this dataset, i'd like to evaluate the possible association between race and gun ownership, and its evolution over years.

As a french, two factors in the US society seem very specifics to me : the racial discrimation and the attitude towards guns.

This short analysis will try to evaluate whether both are somehow related.


* * *

## Part 3: Exploratory data analysis


First, we can have a look at the distribution of interviewees's race over the years  :

```{r}
group_per_year <- gss %>% group_by(year) %>% summarise(count=n())  
average_interviews_per_year <-mean(group_per_year $count)
print (average_interviews_per_year)
group_per_year <- gss %>% group_by(year,race) %>% summarise(total_interviews = n())
ggplot(data=group_per_year,aes(x=year,y=total_interviews,fill=race)) + geom_bar(stat='identity')+geom_hline(yintercept = mean(average_interviews_per_year),colour="blue", linetype="dashed")+annotate("text", x=1980, y=average_interviews_per_year*1.1, label="average interviews", color = "blue")
summary(group_per_year)
```


Two elements to be noticed here :

- the average yearly **number of interviewees** is relatively **stable** over year.
- frequency of interviews switched from every year to every two years from 1993 onwards.
- **race split** with the exception of 2 years (1982,1987 : black oversampling) is also **stable.**


Now we can focus on race and gun ownership.
We first create a dataframe with the variables of interest and some additional ones :

- `year` : year of interview
- `age` : Age of respondent
- `sex` : Respondent's sex
- `fear`: Afraid to walk at night in neighborhood
- `owngun` : Have gun in home
- `educ` :  Highest year of school completed
- `coninc` : Total family income in constant dollars

```{r}
weapon_df <- gss %>% select(year,fear,owngun,sex,age,race,educ,coninc)
str(weapon_df)
```



Let's see for both variable the non-answered ratio :
```{r}
as.data.frame(colMeans(is.na(weapon_df))*100)
```

From this table, we can say that even if 40% of interviewees did not provide an answer for `fear` and `owngun`, it seems, according to the sample size (57061 interviewees), somehow acceptable.

We can now remove the N/A from the dataframe :

```{r}
nrow(weapon_df)
weapon_df<- weapon_df %>% na.omit()
nrow(weapon_df)


```


Now we can quickly see the Pearson correlation between those variable.
First, we convert the categorical variable into numerics values :


```{r}
weapon_df<- weapon_df %>% mutate(fear_num=ifelse(fear=='Yes',1,0))
weapon_df<- weapon_df %>% mutate(owngun_num=ifelse(owngun=='Yes',2,ifelse(owngun=='Refused',1,0)))

weapon_df<- weapon_df %>% mutate(sex_num=ifelse(sex=='Male',1,0))
weapon_df<- weapon_df %>% mutate(race_num=ifelse(race=='Black',0,ifelse(race=='White',2,1)))
                                 
```


Let's plot a correlogramm :

```{r}

weapon_df_numeric<- weapon_df %>% select(-c(fear,sex,race,owngun))

corr <- round(cor(weapon_df_numeric),3)
ggcorrplot(corr, hc.order = TRUE, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           method="circle", 
           colors = c("tomato2", "white", "springgreen3"), 
           title="Correlogram of Selected variables", 
           ggtheme=theme_bw)
```


Well, some elements here :

- **education level** is strongly correlated to the **level of incomes**.
- the **fear** factor is correlated to **gender.** : mens fear less walking in street at night.
- for **gun ownership**, the most correlated variables are in order : **race** (white are more likely ot own guns than others and blacks, $\rho$ = 0.15), **sex** (men are more likely to own guns), **income** (the more income, the more frequent is gunownership).



Now we can prepare a dataframe with gun ownership grouped by year and race : 
```{r}

groupy_gun_race_male<- weapon_df %>% filter(sex=='Male') %>% group_by(year,race,owngun) %>% summarise(total=n(), median_age=median(age)) %>% mutate(ratio=total/sum(total)) %>% filter(owngun=='Yes')

groupy_gun_race_female<- weapon_df  %>% filter(sex=='Female')  %>% group_by(year,race,owngun) %>% summarise(total=n(), median_age=median(age)) %>% mutate(ratio=total/sum(total)) %>% filter(owngun=='Yes')

```



```{r}
p0<-ggplot(groupy_gun_race_male,aes(x=year,y=ratio*100,col=race)) + geom_line() + theme(axis.title.x=element_blank(),axis.title.y=element_blank()) +labs(title = "Male gun ownership %") +scale_y_continuous(limits = c(0, 60))

p1<-ggplot(groupy_gun_race_female,aes(x=year,y=ratio*100,col=race)) + geom_line() + theme(axis.title.x=element_blank(),axis.title.y=element_blank()) +labs(title = "Female gun ownership %")+scale_y_continuous(limits = c(0, 60))

p2<-ggplot(groupy_gun_race_male,aes(x=year,y=median_age,fill=race,color=race))+geom_line()+ theme(axis.title.x=element_blank(),axis.title.y=element_blank()) +labs(title = "Male gun owners median age")+scale_y_continuous(limits = c(20, 65))

p3<-ggplot(groupy_gun_race_female,aes(x=year,y=median_age,fill=race,color=race))+geom_line() + theme(axis.title.x=element_blank(),axis.title.y=element_blank()) +labs(title = "Female  gun owners median age")+scale_y_continuous(limits = c(20, 65))



grid_arrange_shared_legend <- function(...) {
    plots <- list(...)
    g <- ggplotGrob(plots[[1]] + theme(legend.position="bottom"))$grobs
    legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
    lheight <- sum(legend$height)
    grid.arrange(
        do.call(arrangeGrob, lapply(plots, function(x)
            x + theme(legend.position="none"))),
        legend,
        ncol = 1,
        heights = unit.c(unit(1, "npc") - lheight, lheight))
}

grid_arrange_shared_legend(p0, p2, p1, p3)
  
```




* * *

## Part 4: Inference


Before we start testing the independance of gun ownership with race, we can quickly check whether overall  gun ownership did significantly changed over a period of 40 years.

We can proceed by comparing the gun ownership ration in 1972 with 2012 with the following hypothesis :
$H_{0}:ownership_{1972}-ownership_{2012}=0$

$H_{A}:ownership_{1972}- ownership_{2012}\ne 0$

[ownership fall](https://www.washingtonpost.com/news/wonk/wp/2016/06/29/american-gun-ownership-is-now-at-a-30-year-low/?utm_term=.f4605793b86f)
We can compute the corresponding proportions :

```{r}


ownership1973 <- weapon_df %>% filter(year==1973) %>%group_by(owngun)  %>% summarise(count=n())%>% mutate(ratio=count/sum(count), total = sum(count)) %>% filter(owngun=='Yes')
ownership1973

ownership2012 <- weapon_df %>% filter(year==2012) %>%group_by(owngun)  %>% summarise(count=n())%>% mutate(ratio=count/sum(count), total = sum(count))%>% filter(owngun=='Yes')
ownership2012

```


Now we can compute the pooled proportion of gun owners :

```{r}
p_pool <- (661+390)/(1372+1146)
p_pool
```

Let's check the success failure conditions :

$n_{1973} \times  \hat{p}_{pool} \ge 10$

$(1-n_{1973}) \times  \hat{p}_{pool} \ge 10$

$n_{2012} \times  \hat{p}_{pool} \ge 10$

$(1-n_{2012}) \times  \hat{p}_{pool} \ge 10$

```{r}
p_pool * 1372
(1-p_pool)*1372
p_pool * 1146
(1-p_pool)*1146
```

So far, so good. We can compute the standard estimate SE :

$SE = \sqrt{\frac{\hat{p}_{pool}(1-\hat{p}_{pool})}{n_{1973}}+ \frac{\hat{p}_{pool}(1-\hat{p}_{pool})}{n_{2012}}}$

```{r}
SE<- sqrt(p_pool*(1-p_pool)/1372 + p_pool*(1-p_pool)/1146)
SE
```

Now we can compute the p_value :

```{r}
Z<- (0.3403141-0.4817784)/SE
Z
2*pnorm(Z)

```
```{r}
ggplot(data.frame(x = c(-8, 8)), aes(x)) +
  stat_function(fun = dnorm, args = list(mean = 0, sd = SE)) + geom_vline(xintercept = Z,,col='blue',linetype="dashed")+geom_vline(xintercept = -Z,col='blue',linetype="dashed")  +annotate("text", x=-Z*.95, y=10, label="Z", color = "blue")  +annotate("text", x=Z*.95, y=10, label="-Z", color = "blue")
```


From the Z value, it is obvious that the probabily that the gun ownership rate  in 2012 is different than the one in 1973 occurs by chance is almost zero. This has been confirmed by the chart above.


Finally, we can test the independance of the gun ownership rate from the race :

### Hyptheses

$H_{0}:$ Race and gun ownership are independent.

$H_{A}:$ Race and gun ownership are dependent.



### Chi-square test of independance 

I'll use the R function *chisq.test* instead of manually computing it :

```{r}
gun_race <-weapon_df %>% filter(year==2012)  %>% filter(owngun=='Yes' | owngun=='No',owngun!='Refused')

gun_race <- droplevels(gun_race)
gun_race <- table(gun_race$owngun,gun_race$race)
gun_race
chisq.test(gun_race)
```

For the year 2012, we reject the $H_{0}$  : Race and gun ownership are not independant.

What could be interesting is to see the evolution of this p_value over the years :

We can write a generic function to compute the corresponding p.value :

```{r}
chi2_independance_pvalue<- function(df,year_){
gun_race <-df %>% filter(year==year_)  %>% filter(owngun=='Yes' | owngun=='No')

gun_race <- droplevels(gun_race)
gun_race <- table(gun_race$owngun,gun_race$race)

chi2<- chisq.test(gun_race)

return(chi2$p.value)
}
```


Let's compute the evolution of this p.value along the years :

```{r}
gun_asked<-gss %>% group_by(year,owngun) %>% filter(!is.na(owngun)) 
year_asked<-unique(gun_asked$year)
```

```{r}

x<-list()
for (year in year_asked){
 chi2 <-  chi2_independance_pvalue(weapon_df,year)
 x[as.character(year)]<-list('pvalue'=chi2)
}

 
df_pvalues<-as.data.frame(x) %>% gather() 

colnames(df_pvalues)<-c('yearX','pvalue')
df_pvalues<- df_pvalues %>% separate(yearX,into = c("X", "year"), sep = "X")

df_pvalues$log_pvalue<-log(df_pvalues$pvalue)

#df_pvalues<- df_pvalues %>% filter(pvalue<.001)

plot(df_pvalues$year,df_pvalues$pvalue)
ggplot(data=df_pvalues,aes(x=as.numeric(year),y=log_pvalue)) + geom_point() + 
  geom_smooth(method='lm')

```


Chi Square independance test :

```{r}

```

